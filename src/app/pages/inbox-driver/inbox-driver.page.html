<ion-header class="ion-no-border">
  <ion-toolbar mode="md" color="primary">
    <ion-buttons slot="start">
      <ion-button (click)="onBack()" color="light">
        <ion-icon slot="icon-only" name="arrow-back-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>
      <ion-label class="inbox-name">{{ client_name }}</ion-label>
      <ion-label class="inbox-status">Active Now</ion-label>
    </ion-title>
    <ion-buttons slot="end">
      <!-- <ion-button (click)="onCall()" color="light">
        <ion-icon slot="icon-only" name="call"></ion-icon>
      </ion-button> -->
      <a class="button icon-left ion-ios7-telephone button-calm" style="color: white;" color="light"
        href="tel: +2349030061590"> <ion-icon slot="icon-only" name="call"></ion-icon></a>
      <!-- <ion-button color="light">
        <ion-icon slot="icon-only" name="videocam"></ion-icon>
      </ion-button> -->
      <ion-button color="light">
        <ion-icon slot="icon-only" name="information-circle"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
  <ion-row class="ion-padding" style="width: 100%;">
    <div class="main-title">
      <ion-label class="title">Deliver to this Location</ion-label>
    </div>
    <hr style="background-color: blue;" />
    <table style="width: 100%;">
      <tr>
        <td width="15%">
          <img [src]="delivery_img" style="height: 52px; margin-right: 10px;" />
        </td>
        <td width="45%">

          Address: {{ delivery.dropoff }}<br><br>
          {{ delivery.description }}<br>
        </td>
        <td width="40%" align="right">
          <h2>Fee: â‚¦ {{ calculateFee(delivery) | number }}<br /></h2>
        </td>
      </tr>
      <tr>
        <td width="15%">
          &nbsp;
        </td>
        <td colspan="2">
          <br />
          Requested On: {{delivery.timestamp.seconds*1000 | date: 'dd/MM/yyyy hh:MM a'}}
        </td>
      </tr>
    </table>
  </ion-row>
  <ion-button expand="block" fill="solid" color="primary" style="padding: 10px;" (click)="CompleteErrand(delivery)">
    Complete Errand
  </ion-button>

  <!-- <br /> -->

  <!-- <ion-segment [(ngModel)]="selectedTab">
    <ion-segment-button value="map" style="display: flex;" class="segment-tab">
      <br />
      <div class="segment-content">
        <ion-label>Location </ion-label>
      </div>
      <br />
    </ion-segment-button>
  </ion-segment> -->


  <hr style="background-color: black;" />
</ion-header>

<ion-content class="ion-padding">

  <div *ngIf="selectedTab === 'map'">

    <google-map height="90px" width="100%" style="display: none;">
      <map-marker *ngIf="delivery"
        [position]="{lat:parseFloat( delivery.requesterLocation?.lat), lng: parseFloat(delivery.requesterLocation?.lng)}"
        title="Requester Location"></map-marker>
      <map-marker *ngIf="delivery"
        [position]="{lat:parseFloat( delivery.driver_location?.lat), lng: parseFloat(delivery.driver_location?.lng)}"
        title="My Location"></map-marker>

    </google-map>
    <b>Estimated Delivery Time: {{ estimatedTime || 'routing...'}}</b><br /><br/>
    <google-map #map height="325px" width="100%" [center]="center" [zoom]="13">
    </google-map>

  </div>
  <br/>
  <ion-button expand="block" fill="outline" (click)="openChatModal()">
    Chat
    <ion-badge style="margin-left: 10px;" color="secondary" *ngIf="messagesToView.length > 0">{{ messagesToView.length
      }}</ion-badge>
  </ion-button>
  <div *ngIf="selectedTab === 'chat2'">

    <div class="inbox-screen">
      <div class="chat-list" *ngFor="let item of messagesToView">
        <div class="left-message" *ngIf="item.from == selectedUser">
          <div class="sender-img" [ngStyle]="{'background-image': 'url('+cover+')'}"></div>
          <div class="text-type" *ngIf="item.type =='text'"> <ion-label class="msg">{{item.text}}</ion-label> </div>
          <div class="image-type" *ngIf="item.type =='image'">
            <div *ngFor="let img of item.attachment" class="img"
              [ngStyle]="{'background-image': 'url('+img.payload.url+')'}">
            </div>
          </div>
        </div>
        <div class="right-message" *ngIf="item.from != selectedUser">
          <div class="text-type" *ngIf="item.type =='text'"> <ion-label class="msg">{{item.text}}</ion-label> </div>
          <div class="image-type" *ngIf="item.type =='image'">
            <div *ngFor="let img of item.attachment" class="img"
              [ngStyle]="{'background-image': 'url('+img.payload.url+')'}">
            </div>
          </div>
        </div>
      </div>
      <div>

      </div>
    </div>

    <div class="bottom-chat" style="display: none;">
      <ion-button color="light" size="small" class="extra-btn" (click)="onMoreButtons()">
        <ion-icon slot="icon-only" name="add"></ion-icon>
      </ion-button>
      <ion-item lines="none" class="input-content">
        <ion-textarea [(ngModel)]="newMessage" placeholder="message ... " rows="1"></ion-textarea>
        <ion-icon slot="end" name="paper-plane-outline" color="primary" (click)="DoSendMessage()"></ion-icon>
      </ion-item>
    </div>
  </div>

</ion-content><ion-modal #chatModal trigger="open-chat-modal">
  <ng-template>
    <ion-header>
      <ion-toolbar color="primary">
        <ion-title>Chat with {{ client_name }}</ion-title>
        <ion-buttons slot="end">
          <ion-button fill="clear" color="light" (click)="closeChatModal()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="chat-content">
      <div class="chat-container">
        <div *ngFor="let msg of messagesToView" 
             [class.outgoing]="msg.from != selectedUser"
             [class.incoming]="msg.from == selectedUser"
             class="chat-bubble">
          <div *ngIf="msg.type === 'text'" class="text">
            {{ msg.text }}
          </div>
          <div *ngIf="msg.type === 'image'" class="image-list">
            <img *ngFor="let img of msg.attachment" [src]="img.payload.url" />
          </div>
          <div class="timestamp">{{ msg.timestamp | date:'shortTime' }}</div>
        </div>
      </div>
    </ion-content>

    <ion-footer class="chat-footer">
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button fill="clear" color="medium" (click)="onMoreButtons()">
            <ion-icon name="add"></ion-icon>
          </ion-button>
        </ion-buttons>

        <ion-item lines="none" class="message-input">
          <ion-textarea [(ngModel)]="newMessage" placeholder="Type a message..." rows="1"></ion-textarea>
        </ion-item>

        <ion-buttons slot="end">
          <ion-button fill="clear" color="primary" (click)="DoSendMessage()">
            <ion-icon name="send"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-footer>
  </ng-template>
</ion-modal>


<ion-footer class="ion-no-border">
  <ion-toolbar>
    Elapsed Time: {{ elapsedTime }}
  </ion-toolbar>
</ion-footer>